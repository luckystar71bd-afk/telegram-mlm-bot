import os
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext
import sqlite3
from datetime import datetime

TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = 6233944675

conn = sqlite3.connect("mlm.db", check_same_thread=False)
cur = conn.cursor()

cur.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    username TEXT,
    referred_by INTEGER,
    balance INTEGER,
    join_date TEXT
)
""")

cur.execute("""
CREATE TABLE IF NOT EXISTS withdraw_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    amount INTEGER,
    status TEXT,
    date TEXT
)
""")
conn.commit()

def start(update: Update, context: CallbackContext):
    user = update.effective_user
    ref = context.args[0] if context.args else None

    cur.execute("SELECT user_id FROM users WHERE user_id=?", (user.id,))
    if cur.fetchone():
        update.message.reply_text("âœ… à¦†à¦ªà¦¨à¦¿ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡à¦‡ à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà¦¾à¦°à§à¦¡à¥¤")
        return

    cur.execute(
        "INSERT INTO users VALUES (?,?,?,?,?)",
        (user.id, user.username, ref, 0, str(datetime.now()))
    )

    if ref and ref != str(user.id):
        cur.execute("UPDATE users SET balance = balance + 10 WHERE user_id=?", (ref,))
        cur.execute("SELECT referred_by FROM users WHERE user_id=?", (ref,))
        parent = cur.fetchone()
        if parent and parent[0]:
            cur.execute("UPDATE users SET balance = balance + 5 WHERE user_id=?", (parent[0],))

    conn.commit()
    update.message.reply_text("ğŸ‰ à¦¸à§à¦¬à¦¾à¦—à¦¤à¦®! à¦†à¦ªà¦¨à¦¾à¦° à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¤à§ˆà¦°à¦¿ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")

def invite(update: Update, context: CallbackContext):
    uid = update.effective_user.id
    link = f"https://t.me/{context.bot.username}?start={uid}"
    update.message.reply_text(f"ğŸ”— à¦†à¦ªà¦¨à¦¾à¦° Referral Link:\n{link}")

def balance(update: Update, context: CallbackContext):
    uid = update.effective_user.id
    cur.execute("SELECT balance FROM users WHERE user_id=?", (uid,))
    bal = cur.fetchone()[0]
    update.message.reply_text(f"ğŸ’° à¦†à¦ªà¦¨à¦¾à¦° Balance: {bal}")

def team(update: Update, context: CallbackContext):
    uid = update.effective_user.id
    cur.execute("SELECT COUNT(*) FROM users WHERE referred_by=?", (uid,))
    l1 = cur.fetchone()[0]

    cur.execute("""
    SELECT COUNT(*) FROM users 
    WHERE referred_by IN (SELECT user_id FROM users WHERE referred_by=?)
    """, (uid,))
    l2 = cur.fetchone()[0]

    update.message.reply_text(f"ğŸ‘¥ Team Info:\nLevel-1: {l1}\nLevel-2: {l2}")

def withdraw(update: Update, context: CallbackContext):
    uid = update.effective_user.id
    if not context.args:
        update.message.reply_text("â— à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°: /withdraw 100")
        return

    amount = int(context.args[0])
    cur.execute("SELECT balance FROM users WHERE user_id=?", (uid,))
    bal = cur.fetchone()[0]

    if amount > bal:
        update.message.reply_text("âŒ à¦ªà¦°à§à¦¯à¦¾à¦ªà§à¦¤ Balance à¦¨à§‡à¦‡à¥¤")
        return

    cur.execute(
        "INSERT INTO withdraw_requests VALUES (NULL,?,?,?,?)",
        (uid, amount, "Pending", str(datetime.now()))
    )
    cur.execute("UPDATE users SET balance = balance - ? WHERE user_id=?", (amount, uid))
    conn.commit()

    context.bot.send_message(
        ADMIN_ID,
        f"ğŸ“¤ Withdraw Request\nUser ID: {uid}\nAmount: {amount}"
    )
    update.message.reply_text("âœ… Withdraw request à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")

updater = Updater(TOKEN, use_context=True)
dp = updater.dispatcher

dp.add_handler(CommandHandler("start", start))
dp.add_handler(CommandHandler("invite", invite))
dp.add_handler(CommandHandler("balance", balance))
dp.add_handler(CommandHandler("team", team))
dp.add_handler(CommandHandler("withdraw", withdraw))

updater.start_polling()
updater.idle()